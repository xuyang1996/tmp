name: build-push-deploy-docker-image

on:
  push:
    branches: [main]

jobs:
  build-push-deploy-docker-image:
    # if: github.event.pull_request.merged == true
    name: build-push-deploy-docker-image
    runs-on: ubuntu-latest

    steps:
      - name: check-out-code
        uses: actions/checkout@v2

      - name: configure-aws-credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      - name: build-and-push-docker-image
        run: |
          aws_ecr="312013929070.dkr.ecr.ap-northeast-1.amazonaws.com/panda-cronjob"
          git_hash=$(git rev-parse --short "$GITHUB_SHA")

          aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin 312013929070.dkr.ecr.ap-northeast-1.amazonaws.com

          list=`ls -d */`
          for dir in ${list}
          do
              echo "------------------------ prepare to build docker image in ${dir} ------------------------\n"
              tag=${dir%?}-${git_hash}
              image=$aws_ecr:$tag
              docker build -f $dir/Dockerfile -t $image $dir

              echo "------------------------ prepare to push docker image in ${dir} ------------------------\n"
              docker push $image
              echo "\n\n"
          done

      - name: deploy-docker-image-to-aws-eks
        uses: cancue/eks-action@v0.0.2
        env:
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws_region: ap-northeast-1
          cluster_name: panda-k8s
        with:
          args: |

            list=`ls -d */`
            for dir in ${list}
            do
                echo "------------------------ prepare to push docker image in ${dir} ------------------------\n"
                kubectl apply -f ${dir}/deploy.yaml
                echo "\n\n"
            done

            echo "------------------------ get cronjob -n test ------------------------\n"
            kubectl get cronjob -n test
            echo "------------------------ get cronjob -n prod ------------------------\n"
            kubectl get cronjob -n prod

      # - name: build-push-docker-image
      #   uses: mr-smithers-excellent/docker-build-push@v5
      #   with:
      #     image: server
      #     tags: ${{ github.sha }}
      #     # directory: ./test/
      #     # dockerfile: ./test/Dockerfile
      #     registry: 312013929070.dkr.ecr.ap-northeast-1.amazonaws.com
      #   env:
      #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        # with:
        #   image: busyboxplus
        #   tags: ${{ github.sha }}
        #   registry: ghcr.io
        #   username: ${{ github.actor }}
        #   password: ${{ secrets.GITHUB_TOKEN }}
        #   directory: ./test/
        #   dockerfile: ./test/Dockerfile



